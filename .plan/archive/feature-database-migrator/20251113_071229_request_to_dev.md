**Important: Read `README.md` first to understand your role and workflow before starting this assignment.**

**Lifecycle Folder:** feature-database-migrator

**Requirements:** See `.lifecycle/feature-database-migrator/requirements.md` for detailed specifications

## Assignment: Implement GRDB DatabaseMigrator System

### Context

The requirements have been thoroughly reviewed and approved by the review team. You are implementing a database migration system to replace the current drop-and-recreate approach that causes data loss on every schema change.

**Review Status:** APPROVED (all 7 critical gaps resolved, state machine fully specified)

### Implementation Task

Implement the GRDB DatabaseMigrator system as specified in requirements.md, which includes:

1. **Replace current drop/recreate logic** in `DirectGTD/Database.swift:32-103` with GRDB's versioned migration system
2. **Create baseline migration (v1)** that represents the current schema (5 tables: folders, items, tags, notes, item_tags)
3. **Implement backward compatibility** using the approved simple approach:
   - Check for `grdb_migrations` table
   - If missing: Drop any existing tables, run all migrations
   - If present: Use GRDB's standard migration logic
4. **Add comprehensive logging** with NSLog for all migration operations

### State Machine Implementation (MANDATORY)

Follow the state machine specification exactly as documented in requirements.md (lines 108-175):

**6 Database States to handle:**
- Empty (no tables, no metadata)
- Legacy (tables exist, no metadata) → **Drop all tables, run migrations**
- Migrated (metadata exists with v1) → Skip v1
- Partially created → **Drop all tables, run migrations**
- Migration in progress → GRDB handles atomically
- Corrupted metadata → Let GRDB error

**State Detection (2-step algorithm):**
1. Check if `grdb_migrations` table exists
2. If no: Check if any tables exist → Drop all if found
3. Run migrations from v1

**5 Edge Cases with specified handling:**
1. Current schema without metadata → Drop and recreate
2. Partial database → Drop and recreate
3. Migration failure → Rollback + log error
4. Corrupted metadata → Error + user action
5. V1 already applied → Skip migration

### Testing Requirements (MANDATORY)

Implement ALL 6 test cases from requirements.md before marking feature complete:

- **TC1:** Fresh install → All tables created, grdb_migrations contains "v1"
- **TC2:** Legacy database → Reset, tables recreated, grdb_migrations contains "v1"
- **TC3:** V1 already applied → No changes, skip v1
- **TC4:** Future migration (v2) → V2 applied, grdb_migrations contains ["v1", "v2"]
- **TC5:** Migration failure → Rollback, database unchanged, error logged
- **TC6:** Regression → All existing tests pass

**Test Approach:** Use in-memory databases (DatabaseQueue with default configuration)
**Verification Method:** Use `migrator.appliedIdentifiers(dbQueue)` to check which migrations ran

### Technical Details

**Location:** `DirectGTD/Database.swift:32-103`

**GRDB API Usage:**
```swift
var migrator = DatabaseMigrator()
migrator.registerMigration("v1") { db in
    // SQL from database/schema.sql
}
try migrator.migrate(dbQueue)
```

**Schema Source:** `database/schema.sql` (current baseline schema)

**Logging:** Use NSLog() for all migration operations (start, completion, errors)

### Success Criteria

Before marking this work complete, verify:

1. ✅ Fresh install creates all tables via migration system
2. ✅ Legacy database (no metadata) resets and transitions to migration system
3. ✅ Migrated database (v1 applied) preserves data and skips v1
4. ✅ Future schema changes can be added as new migrations (demonstrated by TC4)
5. ✅ All 6 test cases (TC1-TC6) implemented and passing
6. ✅ All existing tests continue to pass
7. ✅ Migration operations logged with NSLog()

### Expected Deliverables

**Status:** COMPLETE / BLOCKED

**Implementation Summary:**
[Brief description of changes made to Database.swift]

**State Machine Implementation:**
[Confirm all 6 states and 5 edge cases are handled per specification]

**Testing Results:**
[Report on all 6 test cases - TC1 through TC6 status]

**Regression Testing:**
[Confirm all existing tests still pass]

**Code Locations:**
[List modified files with line numbers for key changes]

**Known Issues (if any):**
[Any blockers, edge cases not covered, or concerns]

**When completing this work, include a reminder in your response.md for the recipient to read their README.md as crucial process requirements are documented there.**
